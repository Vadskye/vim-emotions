os:
  - linux
language: c
compiler:
  - gcc
    #  - clang
env:
  matrix:
    # - FEATURES=tiny
    # - FEATURES=small
    - FEATURES=normal
sudo: true
cache:
  directories:
    - vim-src
before_install:
  # Set up hg purge.
  - echo '[extensions]' > ~/.hgrc
  - echo 'purge =' >> ~/.hgrc
install:
  - git clone https://github.com/kana/vim-vspec.git
  - |
      if [ ! -d $TRAVIS_BUILD_DIR/vim-src/.hg ]; then
        hg clone https://code.google.com/p/vim $TRAVIS_BUILD_DIR/vim-src
      else
        hg pull -u -R $TRAVIS_BUILD_DIR/vim-src
      fi
before_script:
  - rvm install 2.1.3
  - bundle install
  - bundle show
script:
  - cd $TRAVIS_BUILD_DIR/vim-src/src
  - ./configure --with-features=$FEATURES > /dev/null
  - make > /dev/null
  - ./vim --version
  - make test > /dev/null
  # Clean up, otherwise build results will be cached by Travis.
  - cd ..
  # Remove all files not in the repo, even the ignored ones.
  - rm .hgignore
  - hg purge
  # hg update --clean will restore .hgignore.
  - hg update --clean
  - export PATH=$TRAVIS_BUILD_DIR/vim-src/src:$PATH
  - echo $PATH
  - ls $TRAVIS_BUILD_DIR/vim-src/src
  - which vim
  - sudo mv /usr/bin/vim /usr/bin/vim_backup
  - which vim
  - rake ci
