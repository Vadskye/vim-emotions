os:
  - linux
language: c
compiler:
  - gcc
  - clang
env:
  matrix:
    - FEATURES=tiny
    - FEATURES=small
    - FEATURES=normal
sudo: false
cache:
  directories:
    - vim-src
addons:
  apt:
    packages:
before_install:
  # Set up hg purge.
  - echo '[extensions]' > ~/.hgrc
  - echo 'purge =' >> ~/.hgrc
install:
  - git clone https://github.com/kana/vim-vspec.git
  - if [ ! -d $TRAVIS_BUILD_DIR/vim-src/.hg ]; then
      hg clone https://code.google.com/p/vim $TRAVIS_BUILD_DIR/vim-src
    else
      hg pull -u -R $TRAVIS_BUILD_DIR/vim-src
    fi
      - vim-common
before_script:
  - find $TRAVIS_BUILD_DIR/patches -type f -not -path '*/\.*'
      -exec patch -p1 -d $TRAVIS_BUILD_DIR/vim-src -i {} \;
  - rvm install 2.1.3
  - bundle install
  - bundle show
script:
  - cd $TRAVIS_BUILD_DIR/vim-src/src
  - ./configure --with-features=$FEATURES
  - make
  - ./vim --version
  - make test
  # Clean up, otherwise build results will be cached by Travis.
  - cd ..
  # Remove all files not in the repo, even the ignored ones.
  - rm .hgignore
  - hg purge
  # hg update --clean will restore .hgignore.
  - hg update --clean
  - rake ci
